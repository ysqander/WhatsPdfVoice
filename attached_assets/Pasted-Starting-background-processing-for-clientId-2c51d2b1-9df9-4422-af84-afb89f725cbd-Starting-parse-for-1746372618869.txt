Starting background processing for clientId: 2c51d2b1-9df9-4422-af84-afb89f725cbd
Starting parse for file: /tmp/whatspdf-uploads/file-1746372400043-e8baf7c2-b248-4931-b7b3-c8f61f5b6237.zip
Looking for attachment: -0000007-AUDIO-2025-05-01-18-28-48.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/-0000007-AUDIO-2025-05-01-18-28-48.opus
Looking for attachment: -0000003-AUDIO-2025-05-01-18-31-00.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/-0000003-AUDIO-2025-05-01-18-31-00.opus
Looking for attachment: -0000001-AUDIO-2025-05-01-18-32-10.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/-0000001-AUDIO-2025-05-01-18-32-10.opus
Looking for attachment: 00000002-AUDIO-2025-05-04-10-29-03.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/00000002-AUDIO-2025-05-04-10-29-03.opus
Looking for attachment: 00000004-AUDIO-2025-05-04-10-29-35.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/00000004-AUDIO-2025-05-04-10-29-35.opus
Looking for attachment: 00000005-AUDIO-2025-05-04-10-29-50.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/00000005-AUDIO-2025-05-04-10-29-50.opus
Looking for attachment: 00000006-AUDIO-2025-05-04-10-30-08.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/00000006-AUDIO-2025-05-04-10-30-08.opus
Looking for attachment: 00000008-AUDIO-2025-05-04-10-28-20.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/00000008-AUDIO-2025-05-04-10-28-20.opus
Looking for attachment: 00000010-PHOTO-2025-05-04-10-53-14.jpg in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/00000010-PHOTO-2025-05-04-10-53-14.jpg
Looking for attachment: 00000013-a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127-f564-48fd-8187-6cb13bdb0c4c.pdf in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Found attachment: /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252/WhatsApp Chat - more than 50 messages/00000013-a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127-f564-48fd-8187-6cb13bdb0c4c.pdf
Looking for attachment: 00000014-AUDIO-2025-05-04-11-16-48.opus in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Attachment not found: 00000014-AUDIO-2025-05-04-11-16-48.opus
Looking for attachment: 00000015-PHOTO-2025-05-06-10-20-35.jpg in /tmp/whatspdf-temp/afe62280-6a0b-4c32-b76c-257daa721252
Attachment not found: 00000015-PHOTO-2025-05-06-10-20-35.jpg
Parsed chat export: {
  messageCount: 85,
  participantCount: 2,
  firstMessageSample: {
    timestamp: '2025-05-01T18:27:34',
    sender: 'Iris Adamov',
    content: 'Hi Alex, thereâ€™s mold coming back in the corner of the bedroom again. Can you please arrange for someone to look at it?',
    type: 'text',
    mediaUrl: undefined,
    duration: undefined
  },
  options: {
    includeVoiceMessages: true,
    includeTimestamps: true,
    highlightSenders: true,
    includeImages: true,
    includeAttachments: true
  }
}
Parse completed successfully
Analyzing chat size. Messages: 85
Total media size: 428236 bytes (0.41MB)
Chat exceeds free tier limits. Payment required.
Generating PDF for payment bundle
Starting PDF generation with pdf-lib...
[PDF DEBUG] generatePdfWithPdfLib called for chatData.id: 1
[PDF DEBUG] Attempting storage.getMediaFilesByChat with ID: 1
[PDF DEBUG] storage.getMediaFilesByChat returned 0 files.
PDF: Mapped 0 media file records (0 by message ID) for chat 1
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/-0000007-AUDIO-2025-05-01-18-28-48.opus
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/-0000003-AUDIO-2025-05-01-18-31-00.opus
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/-0000001-AUDIO-2025-05-01-18-32-10.opus
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/00000008-AUDIO-2025-05-04-10-28-20.opus
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/00000002-AUDIO-2025-05-04-10-29-03.opus
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/00000004-AUDIO-2025-05-04-10-29-35.opus
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/00000005-AUDIO-2025-05-04-10-29-50.opus
PDF: No media file found for voice message undefined
PDF (Chat 1): Using original/fallback URL for message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/00000006-AUDIO-2025-05-04-10-30-08.opus
PDF: No media file found for image message undefined
PDF (Chat 1): Using original/fallback URL for image message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/00000010-PHOTO-2025-05-04-10-53-14.jpg
PDF: No media file found for attachment message undefined
PDF (Chat 1): Using original/fallback URL for attachment message N/A -> https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/media/00000013-a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127-f564-48fd-8187-6cb13bdb0c4c.pdf
PDF: Media files map size: 0
PDF: Media files array length: 0
PDF: Unique media files count: 0
[PDF DEBUG] Summary Page: displayMediaFiles count: 0
[PDF DEBUG] Summary Page: displayMediaFiles is empty. mediaFilesMap size was 0. uniqueMediaFiles size was 0
PDF: No media files to display in summary table
Saving PDF document...
PDF file written successfully to: /tmp/whatspdf/pdfs/f978b495-b61e-4cc0-9dd6-5442a5c5170c.pdf
PDF details: { pdfId: 'f978b495-b61e-4cc0-9dd6-5442a5c5170c', size: 11977 }
PDF generation completed for payment: /tmp/whatspdf/pdfs/f978b495-b61e-4cc0-9dd6-5442a5c5170c.pdf
Error creating payment bundle: error: column "bundle_id" of relation "payment_bundles" does not exist
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async PaymentService.createPaymentBundle (/home/runner/workspace/server/lib/paymentService.ts:32:20)
    at async <anonymous> (/home/runner/workspace/server/controllers/uploadController.ts:171:30) {
  length: 137,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '38',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_target.c',
  line: '1066',
  routine: 'checkInsertTargets'
}
R2 connection successful
R2 connection successful, proceeding with media uploads
Found 10 media messages to upload to R2
Processing 8 voice messages
Trying alternate media path: /tmp/whatspdf/media/-0000007-AUDIO-2025-05-01-18-28-48.opus
Uploading voice message to R2: /tmp/whatspdf/media/-0000007-AUDIO-2025-05-01-18-28-48.opus
Uploaded file to R2: chats/2/voice/_0000007_audio_2025_05_01_18_28_48_c370e720-73bf-4ce5-813f-e4823448e4f7.opus
Uploaded media file to R2: chats/2/voice/_0000007_audio_2025_05_01_18_28_48_c370e720-73bf-4ce5-813f-e4823448e4f7.opus
Setting message 3 media URL to proxy: https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/api/media/proxy/b09af9e5-5a65-4741-a2d4-2b4a06dee8fa
Uploaded voice message to R2, key: chats/2/voice/_0000007_audio_2025_05_01_18_28_48_c370e720-73bf-4ce5-813f-e4823448e4f7.opus
Trying alternate media path: /tmp/whatspdf/media/-0000003-AUDIO-2025-05-01-18-31-00.opus
Uploading voice message to R2: /tmp/whatspdf/media/-0000003-AUDIO-2025-05-01-18-31-00.opus
Uploaded file to R2: chats/2/voice/_0000003_audio_2025_05_01_18_31_00_d5c11735-fe6d-4f83-9f10-f735d01fba32.opus
Uploaded media file to R2: chats/2/voice/_0000003_audio_2025_05_01_18_31_00_d5c11735-fe6d-4f83-9f10-f735d01fba32.opus
Setting message 7 media URL to proxy: https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/api/media/proxy/9f00e912-dfaa-44ad-8702-a0851ce2a338
Uploaded voice message to R2, key: chats/2/voice/_0000003_audio_2025_05_01_18_31_00_d5c11735-fe6d-4f83-9f10-f735d01fba32.opus
Trying alternate media path: /tmp/whatspdf/media/-0000001-AUDIO-2025-05-01-18-32-10.opus
Uploading voice message to R2: /tmp/whatspdf/media/-0000001-AUDIO-2025-05-01-18-32-10.opus
Uploaded file to R2: chats/2/voice/_0000001_audio_2025_05_01_18_32_10_ff2f6da8-ea6e-4dac-a695-e96dc8ce1a4d.opus
Upload request received: {
  headers: {
    host: 'eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev',
    'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36',
    'content-length': '438412',
    accept: '*/*',
    'accept-encoding': 'gzip, deflate, br, zstd',
    'accept-language': 'en-GB,en;q=0.8',
    'content-type': 'multipart/form-data; boundary=----WebKitFormBoundaryRDNKx1m0m8o0WuT0',
    cookie: '__stripe_mid=e9a76655-bc8c-4716-9b97-1ae2ea13c1efee7b8c; __stripe_sid=d6b762cb-d10b-428b-876f-432dd597f634c4f1b6',
    origin: 'https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev',
    referer: 'https://eb380b0b-741a-48b9-8f0b-a23721457a3d-00-8jgcrykxyo77.worf.replit.dev/',
    'sec-ch-ua': '"Brave";v="135", "Not-A.Brand";v="8", "Chromium";v="135"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"macOS"',
    'sec-fetch-dest': 'empty',
    'sec-fetch-mode': 'cors',
    'sec-fetch-site': 'same-origin',
    'sec-gpc': '1',
    'x-forwarded-for': '45.155.143.100, 10.83.10.80',
    'x-forwarded-proto': 'https',
    'x-replit-user-bio': '',
    'x-replit-user-id': '',
    'x-replit-user-name': '',
    'x-replit-user-profile-image': '',
    'x-replit-user-roles': '',
    'x-replit-user-teams': '',
    'x-replit-user-url': ''
  },
  contentType: 'multipart/form-data; boundary=----WebKitFormBoundaryRDNKx1m0m8o0WuT0',
  files: undefined,
  file: {
    fieldname: 'file',
    originalname: 'WhatsApp Chat - more than 50 messages.zip',
    encoding: '7bit',
    mimetype: 'application/zip',
    destination: '/tmp/whatspdf-uploads',
    filename: 'file-1746376289583-3628db69-346d-437b-86dc-9ff988709f90.zip',
    path: '/tmp/whatspdf-uploads/file-1746376289583-3628db69-346d-437b-86dc-9ff988709f90.zip',
    size: 437973
  },
  body: [Object: null prototype] {
    options: '{"includeVoiceMessages":true,"includeTimestamps":true,"highlightSenders":true,"includeImages":true,"includeAttachments":true}'
  }
}
File details: {
  originalname: 'WhatsApp Chat - more than 50 messages.zip',
  mimetype: 'application/zip',
  size: 437973,
  path: '/tmp/whatspdf-uploads/file-1746376289583-3628db69-346d-437b-86dc-9ff988709f90.zip'
}
Waiting for SSE connection for clientId: e67661ef-66a3-4837-a9cf-3c5d67cd83af
4:31:30 PM [express] POST /api/whatsapp/process 200 in 571ms :: {"clientId":"e67661ef-66a3-4837-a9cf…
Starting background processing for clientId: e67661ef-66a3-4837-a9cf-3c5d67cd83af
Starting parse for file: /tmp/whatspdf-uploads/file-1746376289583-3628db69-346d-437b-86dc-9ff988709f90.zip
Looking for attachment: -0000007-AUDIO-2025-05-01-18-28-48.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/-0000007-AUDIO-2025-05-01-18-28-48.opus
Looking for attachment: -0000003-AUDIO-2025-05-01-18-31-00.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/-0000003-AUDIO-2025-05-01-18-31-00.opus
Looking for attachment: -0000001-AUDIO-2025-05-01-18-32-10.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/-0000001-AUDIO-2025-05-01-18-32-10.opus
Looking for attachment: 00000002-AUDIO-2025-05-04-10-29-03.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/00000002-AUDIO-2025-05-04-10-29-03.opus
Looking for attachment: 00000004-AUDIO-2025-05-04-10-29-35.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/00000004-AUDIO-2025-05-04-10-29-35.opus
Looking for attachment: 00000005-AUDIO-2025-05-04-10-29-50.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/00000005-AUDIO-2025-05-04-10-29-50.opus
Looking for attachment: 00000006-AUDIO-2025-05-04-10-30-08.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/00000006-AUDIO-2025-05-04-10-30-08.opus
Looking for attachment: 00000008-AUDIO-2025-05-04-10-28-20.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/00000008-AUDIO-2025-05-04-10-28-20.opus
Looking for attachment: 00000010-PHOTO-2025-05-04-10-53-14.jpg in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/00000010-PHOTO-2025-05-04-10-53-14.jpg
Looking for attachment: 00000013-a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127-f564-48fd-8187-6cb13bdb0c4c.pdf in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Found attachment: /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d/WhatsApp Chat - more than 50 messages/00000013-a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127-f564-48fd-8187-6cb13bdb0c4c.pdf
Looking for attachment: 00000014-AUDIO-2025-05-04-11-16-48.opus in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Attachment not found: 00000014-AUDIO-2025-05-04-11-16-48.opus
Looking for attachment: 00000015-PHOTO-2025-05-06-10-20-35.jpg in /tmp/whatspdf-temp/55a982f5-bf9d-4ec1-9725-9851f6a9741d
Attachment not found: 00000015-PHOTO-2025-05-06-10-20-35.jpg
Parsed chat export: {
  messageCount: 85,
  participantCount: 2,
  firstMessageSample: {
    timestamp: '2025-05-01T18:27:34',
    sender: 'Iris Adamov',
    content: 'Hi Alex, there’s mold coming back in the corner of the bedroom again. Can you please arrange for someone to look at it?',
    type: 'text',
    mediaUrl: undefined,
    duration: undefined
  },
  options: {
    includeVoiceMessages: true,
    includeTimestamps: true,
    highlightSenders: true,
    includeImages: true,
    includeAttachments: true
  }
}
Parse completed successfully
Analyzing chat size. Messages: 85
Total media size: 428236 bytes (0.41MB)
Chat exceeds free tier limits. Payment required.
Created payment bundle: { bundleId: '063237bb-8d34-420a-a02a-ef79993dfc5f' }
R2 connection successful
R2 connection successful, proceeding with media uploads
Found 10 media messages to upload to R2
Processing 8 voice messages
Uploading voice message to R2: /tmp/whatspdf/media/-0000007-AUDIO-2025-05-01-18-28-48.opus
Uploaded file to R2: chats/1/voice/_0000007_audio_2025_05_01_18_28_48_0ed3d181-3b22-4548-a020-de88fc396532.opus
Uploaded media file to R2: chats/1/voice/_0000007_audio_2025_05_01_18_28_48_0ed3d181-3b22-4548-a020-de88fc396532.opus
Uploading voice message to R2: /tmp/whatspdf/media/-0000003-AUDIO-2025-05-01-18-31-00.opus
Uploaded file to R2: chats/1/voice/_0000003_audio_2025_05_01_18_31_00_74b71178-2ed9-441f-bba2-21aa30384279.opus
Uploaded media file to R2: chats/1/voice/_0000003_audio_2025_05_01_18_31_00_74b71178-2ed9-441f-bba2-21aa30384279.opus
Uploading voice message to R2: /tmp/whatspdf/media/-0000001-AUDIO-2025-05-01-18-32-10.opus
Uploaded file to R2: chats/1/voice/_0000001_audio_2025_05_01_18_32_10_577eea9a-6eb6-41d5-815c-ce6a07630345.opus
Uploaded media file to R2: chats/1/voice/_0000001_audio_2025_05_01_18_32_10_577eea9a-6eb6-41d5-815c-ce6a07630345.opus
Uploading voice message to R2: /tmp/whatspdf/media/00000002-AUDIO-2025-05-04-10-29-03.opus
Uploaded file to R2: chats/1/voice/00000002_audio_2025_05_04_10_29_03_22c636e7-7a84-4fcf-ab5b-2a494a8fe303.opus
Uploaded media file to R2: chats/1/voice/00000002_audio_2025_05_04_10_29_03_22c636e7-7a84-4fcf-ab5b-2a494a8fe303.opus
Uploading voice message to R2: /tmp/whatspdf/media/00000004-AUDIO-2025-05-04-10-29-35.opus
Uploaded file to R2: chats/1/voice/00000004_audio_2025_05_04_10_29_35_19979f6c-960d-4b1a-ad11-42305f793fb3.opus
Uploaded media file to R2: chats/1/voice/00000004_audio_2025_05_04_10_29_35_19979f6c-960d-4b1a-ad11-42305f793fb3.opus
Uploading voice message to R2: /tmp/whatspdf/media/00000005-AUDIO-2025-05-04-10-29-50.opus
Uploaded file to R2: chats/1/voice/00000005_audio_2025_05_04_10_29_50_3d76d72b-270f-45eb-824a-9335ac162b11.opus
Uploaded media file to R2: chats/1/voice/00000005_audio_2025_05_04_10_29_50_3d76d72b-270f-45eb-824a-9335ac162b11.opus
Uploading voice message to R2: /tmp/whatspdf/media/00000006-AUDIO-2025-05-04-10-30-08.opus
Uploaded file to R2: chats/1/voice/00000006_audio_2025_05_04_10_30_08_56972d91-0ba9-49bc-b7f0-e3ac2a36c52c.opus
Uploaded media file to R2: chats/1/voice/00000006_audio_2025_05_04_10_30_08_56972d91-0ba9-49bc-b7f0-e3ac2a36c52c.opus
Uploading voice message to R2: /tmp/whatspdf/media/00000008-AUDIO-2025-05-04-10-28-20.opus
Uploaded file to R2: chats/1/voice/00000008_audio_2025_05_04_10_28_20_5bfa2d79-1cd9-4051-b881-ac8f0c694071.opus
Uploaded media file to R2: chats/1/voice/00000008_audio_2025_05_04_10_28_20_5bfa2d79-1cd9-4051-b881-ac8f0c694071.opus
Processing 1 image messages
Uploading image to R2: /tmp/whatspdf/media/00000010-PHOTO-2025-05-04-10-53-14.jpg
Uploaded file to R2: chats/1/image/00000010_photo_2025_05_04_10_53_14_a400ea8b-b1e7-4724-895e-8f1558fda2d1.jpg
Uploaded media file to R2: chats/1/image/00000010_photo_2025_05_04_10_53_14_a400ea8b-b1e7-4724-895e-8f1558fda2d1.jpg
Processing 1 attachment messages
Uploading attachment to R2: /tmp/whatspdf/media/00000013-a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127-f564-48fd-8187-6cb13bdb0c4c.pdf
Uploaded file to R2: chats/1/attachment/00000013_a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127_f564_48fd_8187_6cb13bdb0c4c_8fa8d806-cbbf-4993-a954-900366f84259.pdf
Uploaded media file to R2: chats/1/attachment/00000013_a89e0bcf_2d07_4959_bfbb_deb4d0b97756_1507e127_f564_48fd_8187_6cb13bdb0c4c_8fa8d806-cbbf-4993-a954-900366f84259.pdf
Generating PDF for payment bundle after media uploads
Starting PDF generation with pdf-lib...
[PDF DEBUG] generatePdfWithPdfLib called for chatData.id: 1
[PDF DEBUG] Attempting storage.getMediaFilesByChat with ID: 1
[PDF DEBUG] storage.getMediaFilesByChat returned 10 files.
[PDF DEBUG] First media file sample: ID=076cf473-15ae-47a0-a422-d5e7c1933b2b, type=voice, messageId=undefined, chatExportId=1
PDF: Media file 1/10: ID=076cf473-15ae-47a0-a422-d5e7c1933b2b, type=voice, messageId=undefined
PDF: Media file 2/10: ID=6059466d-5e85-49ab-8e2a-f50c516238d7, type=voice, messageId=undefined
PDF: Media file 3/10: ID=19582896-2ff6-45ca-92f7-b0ef8de1f1a3, type=voice, messageId=undefined
PDF: Media file 4/10: ID=7bb986f7-29e5-4058-95a3-352dd5edf282, type=voice, messageId=undefined
PDF: Media file 5/10: ID=d574960c-ccbd-4d44-9fb1-251535840df2, type=voice, messageId=undefined
PDF: Media file 6/10: ID=e9947ed1-50be-4393-995f-28a67095a5ce, type=voice, messageId=undefined
PDF: Media file 7/10: ID=ec74d663-aaf7-4576-841a-cb94298bb49a, type=voice, messageId=undefined
PDF: Media file 8/10: ID=11cdeb19-abe1-46c0-a89c-bd7d9b7a7346, type=voice, messageId=undefined
PDF: Media file 9/10: ID=126c921f-9a71-4fd2-af97-abcd642d9e28, type=image, messageId=undefined
PDF: Media file 10/10: ID=40426660-7960-42b4-ab3f-adfa553ca6ce, type=attachment, messageId=undefined
PDF: Mapped 10 media file records (0 by message ID) for chat 1
PDF: Media files map size: 10
PDF: Media files array length: 10
PDF: Unique media files count: 10
[PDF DEBUG] Summary Page: displayMediaFiles count: 10
[PDF DEBUG] Summary Page: First display file sample: ID=076cf473-15ae-47a0-a422-d5e7c1933b2b, Name=-0000007-AUDIO-2025-05-01-18-28-48.opus, Type=voice
PDF: Displaying 10 media files in summary table
PDF: Using calculated SHA-256 hash for 076cf473-15ae-47a0-a422-d5e7c1933b2b: 5d4f3c9f...
PDF: Using calculated SHA-256 hash for 6059466d-5e85-49ab-8e2a-f50c516238d7: 16257612...
PDF: Using calculated SHA-256 hash for 19582896-2ff6-45ca-92f7-b0ef8de1f1a3: 1adddc64...
PDF: Using calculated SHA-256 hash for 7bb986f7-29e5-4058-95a3-352dd5edf282: c5b41078...
PDF: Using calculated SHA-256 hash for d574960c-ccbd-4d44-9fb1-251535840df2: ac73832d...
PDF: Using calculated SHA-256 hash for e9947ed1-50be-4393-995f-28a67095a5ce: 88823369...
PDF: Using calculated SHA-256 hash for ec74d663-aaf7-4576-841a-cb94298bb49a: acf4d0d9...
PDF: Using calculated SHA-256 hash for 11cdeb19-abe1-46c0-a89c-bd7d9b7a7346: 0a9b16ab...
PDF: Using calculated SHA-256 hash for 126c921f-9a71-4fd2-af97-abcd642d9e28: 9125427f...
PDF: Using calculated SHA-256 hash for 40426660-7960-42b4-ab3f-adfa553ca6ce: 84b8d5b2...
Saving PDF document...
PDF file written successfully to: /tmp/whatspdf/pdfs/3158e362-56ae-46e8-a6dd-06509286b982.pdf
PDF details: { pdfId: '3158e362-56ae-46e8-a6dd-06509286b982', size: 4965 }
PDF generation completed for payment: /tmp/whatspdf/pdfs/3158e362-56ae-46e8-a6dd-06509286b982.pdf
4:31:35 PM [express] GET /api/whatsapp/process-status 200 in 5551ms